<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
  <link rel="stylesheet" href="/css/toast/app.css" />

  <style>
    body {
        background-color: #f8f9fa;
      }
      .container {
        max-width: 900px;
        margin-top: 50px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      }
  </style>
</head>
<body>

  <div class="container">
  <header class="header">
    <nav class="navbar">
      <button class="button is-rounded today">Today</button>
      <button class="button is-rounded prev">
        <img alt="prev" src="/images/ic-arrow-line-left.png" srcset="/images/ic-arrow-line-left@2x.png 2x, /images/ic-arrow-line-left@3x.png 3x">
      </button>
      <button class="button is-rounded next">
        <img alt="next" src="/images/ic-arrow-line-right.png" srcset="/images/ic-arrow-line-right@2x.png 2x, /images/ic-arrow-line-right@3x.png 3x">
      </button>
      <span class="navbar--range"></span>
    </nav>
  </header>
  <div id="total"></div>
  <div id="calendar" style="height: 600px;"></div>

  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.ie11.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="/scripts/toast/utils.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
    const Calendar = tui.Calendar;
    const container = document.getElementById('calendar');
    const calendarOptions = {
      defaultView: 'month',
      timezone: {
        zones: [
          {
            timezoneName: 'Asia/Seoul',
            displayLabel: 'Seoul',
          },
        ],
      },
      calendars: [
        { id: 'EXPENSE', name: 'EXPENSE' },
        { id: 'INCOME', name: 'INCOME' },
      ],
    };

    const calendar = new Calendar(container, calendarOptions);

    calendar.setCalendars([
      {
        id: 'EXPENSE',
        name: 'EXPENSE',
        color: '#f20707',
        backgroundColor: '#ffffff',
        borderColor: '#ffffff',
      },
      {
        id: 'INCOME',
        name: 'INCOME',
        color: '#1302fa',
        backgroundColor: '#ffffff',
        borderColor: '#ffffff',
      },
    ]);

    // 날짜 버튼 클릭 핸들러
    function onDateButtonClick(action) {
      calendar[action]();
      updateCalendar();
    }

    // 캘린더 업데이트 및 AJAX 요청
    function updateCalendar() {
      const yearMonth = getNavbarRange(calendar.getDateRangeStart(), calendar.getDateRangeEnd(), 'month');
      displayRenderRange();
      fetchMonthlyEvents(yearMonth);
      fetchMonthlySummary(yearMonth);
    }

    // 달력 범위 표시 업데이트
    const range = document.querySelector(".navbar--range");
    function displayRenderRange() {
      range.textContent = getNavbarRange(calendar.getDateRangeStart(), calendar.getDateRangeEnd(), 'month');
    }

    // AJAX 요청으로 월별 이벤트 가져오기
    function fetchMonthlyEvents(yearMonth) {
      const url = `http://localhost:8080/transactions/monthly/${yearMonth}`;

      $.ajax({
        url: url,
        method: 'GET',
        dataType: 'json',
        success: function(data) {

          calendar.clear();
          const events = data.map((item, index) => {
            return {
              id: `dailySummary${index + 1}`,
              calendarId: item.status,
              title: item.status === 'EXPENSE' ? `- ${item.total}` : `+ ${item.total}`,
              start: item.date,
              end: item.date,
              category: "allday"
            };
          });
          calendar.createEvents(events);
        },
        error: function(error) {
          console.error('AJAX 오류:', error);
        }
      });
    }

    // AJAX 요청으로 월별 집계 가져오기
    function fetchMonthlySummary(yearMonth) {
      const url = `http://localhost:8080/transactions/monthlySummary/${yearMonth}`;
      const total = document.querySelector('#total');

      $.ajax({
        url: url,
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          total.innerHTML = `
            <h2>총 지출: ${data.totalExpense}</h2>
            <h2>총 수입: ${data.totalIncome}</h2>
          `;
        },
        error: function(error) {
          console.error('AJAX 오류:', error);
        }
      });
    }

    // 초기 설정 및 이벤트 리스너 설정
    document.querySelector(".prev").addEventListener('click', () => onDateButtonClick('prev'));
    document.querySelector(".next").addEventListener('click', () => onDateButtonClick('next'));
    document.querySelector(".today").addEventListener('click', () => onDateButtonClick('today'));

    // 초기 화면 로드
    updateCalendar();
  </script>

</div>
</body>
</html>
